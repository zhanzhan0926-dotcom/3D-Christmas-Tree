<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>3D æ˜Ÿæ²³å›å¿†åœ£è¯æ ‘</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); /* æ·±é‚ƒå®‡å®™èƒŒæ™¯ */
        }
        
        /* UI ç•Œé¢ */
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€æ–‡å­— */
        }

        h1 {
            margin: 0;
            font-size: 24px;
            text-shadow: 0 0 10px #bd00ff;
            letter-spacing: 2px;
        }

        p {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }

        /* ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        #upload-btn-wrapper {
            margin-top: 15px;
            pointer-events: auto; /* æŒ‰é’®éœ€è¦ç‚¹å‡» */
        }

        .custom-file-upload {
            border: 1px solid #bd00ff;
            display: inline-block;
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 20px;
            background: rgba(0,0,0,0.5);
            transition: all 0.3s;
            font-size: 14px;
            color: #fff;
            box-shadow: 0 0 15px rgba(189, 0, 255, 0.3);
        }

        .custom-file-upload:hover {
            background: #bd00ff;
            box-shadow: 0 0 25px rgba(189, 0, 255, 0.8);
        }

        input[type="file"] {
            display: none;
        }

        /* åŠ è½½æç¤º */
        #loading {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: #555;
            font-size: 12px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="ui-container">
        <h1>ğŸŒŒ Galaxy Xmas Tree</h1>
        <p>æ‹–åŠ¨æ—‹è½¬ Â· æ»šè½®ç©¿è¶Šæ˜Ÿæ²³</p>
        
        <div id="upload-btn-wrapper">
            <label for="file-upload" class="custom-file-upload">
                ğŸ“· ä¸Šä¼ ç…§ç‰‡ (æ”¯æŒå¤šé€‰)
            </label>
            <input id="file-upload" type="file" multiple accept="image/*"/>
        </div>
    </div>

    <div id="loading">åŒå‡»å±å¹•æˆ–æ»šåŠ¨æ»šè½®è¿›å…¥æ˜Ÿæ²³</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. åœºæ™¯é…ç½® (å®‡å®™é£æ ¼) ---
        const scene = new THREE.Scene();
        // è¿œå¤„çš„é›¾æ°”ï¼Œè®©æ˜Ÿæ˜Ÿæœ‰æ¸éšæ•ˆæœ
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 40); // åˆå§‹è¿œæ™¯

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        // å¼€å¯é«˜æ€§èƒ½é¢œè‰²æ¨¡å¼
        document.body.appendChild(renderer.domElement);

        // --- 2. æ§åˆ¶å™¨ (ä¿®å¤äº†åŸæœ¬æ— æ³•æ»šè½®çš„é—®é¢˜) ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // é˜»å°¼æƒ¯æ€§
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;    // é—²ç½®æ—¶è‡ªåŠ¨æ¼«æ¸¸
        controls.autoRotateSpeed = 0.8; 
        controls.enablePan = false;    // ç¦æ­¢å³é”®å¹³ç§»ï¼Œä¿è¯æ ‘åœ¨ä¸­å¿ƒ
        controls.minDistance = 0.5;    // å…è®¸æ— é™æ¥è¿‘æ ¸å¿ƒ (ç©¿è¶Šæ•ˆæœ)
        controls.maxDistance = 60;

        // --- 3. ç”Ÿæˆæ˜Ÿæ²³åœ£è¯æ ‘ (Galaxy Math) ---
        const particleCount = 25000; // ä¸¤ä¸‡äº”åƒé¢—æ˜Ÿæ˜Ÿ
        const galaxyGeo = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];
        const sizes = [];

        // é¢œè‰²åº“ï¼šé‡‘è‰²ã€ç´«è‰²ã€é’è‰²ã€ç™½è‰²
        const colorPalette = [
            new THREE.Color('#ffcc00'), // é‡‘
            new THREE.Color('#ff0055'), // ç´«çº¢
            new THREE.Color('#00ccff'), // é’
            new THREE.Color('#ffffff')  // ç™½
        ];

        const treeHeight = 30;
        const maxRadius = 12;

        for (let i = 0; i < particleCount; i++) {
            // y: é«˜åº¦ (0 åˆ° 1)
            const y = Math.random();
            const h = y * treeHeight - treeHeight / 2;

            // èºæ—‹æ˜Ÿç³»é€»è¾‘
            // è§’åº¦éšé«˜åº¦æ—‹è½¬ (èºæ—‹ä¸Šå‡)
            const spiralAngle = y * 15; // æ—‹è½¬åœˆæ•°
            const branchAngle = (i % 3) * (Math.PI * 2 / 3); // åˆ†å‡º3ä¸ªæ—‹è‡‚
            const finalAngle = spiralAngle + branchAngle + Math.random() * 0.5;

            // åŠå¾„ï¼šéšé«˜åº¦å˜å°ï¼Œå½¢æˆåœ†é”¥ï¼Œä½†åŠ å…¥éšæœºæ‰©æ•£æ¨¡æ‹Ÿæ˜Ÿäº‘
            const originalRadius = maxRadius * (1 - y);
            // éšæœºæ‰©æ•£ï¼Œåˆ¶é€ ä¸€ç§"é›¾çŠ¶"è¾¹ç¼˜
            const randomOffset = Math.pow(Math.random(), 3) * 5; 
            const r = originalRadius + randomOffset;

            const x = Math.cos(finalAngle) * r;
            const z = Math.sin(finalAngle) * r;

            positions.push(x, h, z);

            // é¢œè‰²é€»è¾‘ï¼šæ ¸å¿ƒäº®é»„ï¼Œå¤–éƒ¨ç´«é’
            const distToCenter = Math.sqrt(x*x + z*z) / maxRadius;
            let color;
            if (Math.random() > 0.95) {
                color = colorPalette[3]; // éšæœºé—ªçƒç™½æ˜Ÿ
            } else if (distToCenter < 0.3) {
                color = colorPalette[0]; // æ ¸å¿ƒé‡‘
            } else {
                // å¤–éƒ¨ç´«/é’éšæœº
                color = colorPalette[1].clone().lerp(colorPalette[2], Math.random());
            }
            colors.push(color.r, color.g, color.b);

            // å¤§å°é€»è¾‘
            sizes.push(Math.random() * 0.3); 
        }

        galaxyGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        galaxyGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        galaxyGeo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

        // æè´¨ï¼šä½¿ç”¨å‘å…‰è´´å›¾ + AdditiveBlending
        const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
        const starMaterial = new THREE.PointsMaterial({
            size: 0.2,
            vertexColors: true,
            map: sprite,
            blending: THREE.AdditiveBlending, // å…³é”®ï¼šå åŠ å‘å…‰æ¨¡å¼
            depthWrite: false, // å…è®¸é€æ˜å åŠ 
            transparent: true,
            opacity: 0.8,
            sizeAttenuation: true // è¿œå°è¿‘å¤§
        });

        const starSystem = new THREE.Points(galaxyGeo, starMaterial);
        scene.add(starSystem);


        // --- 4. ç…§ç‰‡æ‚¬æµ®ç³»ç»Ÿ (Photo Gallery) ---
        const photoGroup = new THREE.Group();
        scene.add(photoGroup);
        const photoSprites = [];

        // é»˜è®¤å ä½å›¾ç”Ÿæˆå™¨ (Canvas)
        function createPlaceholderTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(20, 20, 50, 0.8)';
            ctx.fillRect(0,0,512,512);
            ctx.strokeStyle = '#00ccff';
            ctx.lineWidth = 20;
            ctx.strokeRect(20,20,472,472);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText("Upload", 256, 200);
            ctx.fillText("Photo", 256, 312);
            return new THREE.CanvasTexture(canvas);
        }

        // åˆå§‹åŒ– 20 ä¸ªç…§ç‰‡ä½
        const defaultTex = createPlaceholderTexture("Photo");
        const photoCount = 20;

        for (let i = 0; i < photoCount; i++) {
            const material = new THREE.SpriteMaterial({ 
                map: defaultTex,
                color: 0xffffff,
                transparent: true,
                opacity: 0.9
            });
            const sprite = new THREE.Sprite(material);

            // éšæœºæ•£è½åœ¨æ ‘çš„å†…éƒ¨ (èºæ—‹åˆ†å¸ƒ)
            const y = Math.random() * 0.8 + 0.1; // é¿å¼€æœ€é¡¶å’Œæœ€åº•
            const h = y * treeHeight - treeHeight / 2;
            const r = maxRadius * (1 - y) * 0.6; // åœ¨æ ‘å†…éƒ¨ 60% çš„ä½ç½®
            const angle = y * 15 + (Math.random() * Math.PI); // è·Ÿéšèºæ—‹

            sprite.position.set(
                Math.cos(angle) * r, 
                h, 
                Math.sin(angle) * r
            );
            
            // åˆå§‹å¤§å°
            sprite.scale.set(3, 3, 3);
            
            // å­˜ä¸ªæ ‡è®°ï¼Œç”¨äºåŠ¨ç”»
            sprite.userData = {
                id: i,
                originalY: h,
                speed: Math.random() * 0.5 + 0.5
            };

            photoGroup.add(sprite);
            photoSprites.push(sprite);
        }

        // --- 5. ä¸Šä¼ åŠŸèƒ½å®ç° ---
        const fileInput = document.getElementById('file-upload');
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (!files.length) return;

            // éå†ä¸Šä¼ çš„æ–‡ä»¶å¹¶æ›¿æ¢ç…§ç‰‡çº¹ç†
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const tex = new THREE.Texture(img);
                        tex.needsUpdate = true;
                        tex.colorSpace = THREE.SRGBColorSpace; // ä¿®æ­£é¢œè‰²

                        // å¾ªç¯æ›¿æ¢ç°æœ‰ Sprite
                        // å¦‚æœä¸Šä¼ å›¾æ¯” Sprite å¤šï¼Œå°±å¾ªç¯ç”¨ï¼›å¦‚æœå°‘ï¼Œå°±åªæ¢å‰å‡ ä¸ª
                        const spriteIndex = index % photoSprites.length; // ç®€å•çš„åˆ†é…ç­–ç•¥
                        
                        // ç”šè‡³å¯ä»¥ä¸ºæ–°å›¾ç‰‡åˆ›å»ºæ–°çš„ Spriteï¼Œè¿™é‡Œç®€å•èµ·è§ç›´æ¥æ›¿æ¢
                        photoSprites.forEach((sprite, i) => {
                            // ç®€å•çš„è½®è¯¢æ›¿æ¢é€»è¾‘ï¼šæ¯éš”å‡ å¼ æ¢ä¸€å¼ ï¼Œæˆ–è€…æŒ‰é¡ºåº
                            if (i % files.length === index) {
                                sprite.material.map = tex;
                            }
                        });
                    };
                };
                reader.readAsDataURL(file);
            });
            
            alert(`å·²åŠ è½½ ${files.length} å¼ ç…§ç‰‡ï¼Œå¿«å»æ˜Ÿæ²³é‡Œå¯»æ‰¾å®ƒä»¬å§ï¼`);
        });


        // --- 6. é¡¶éƒ¨è¶…æ–°æ˜Ÿ (Supernova) ---
        const starGeo = new THREE.SphereGeometry(1, 32, 32);
        const starMat = new THREE.MeshBasicMaterial({ color: 0xffffff }); // çº¯ç™½æ ¸å¿ƒ
        const supernova = new THREE.Mesh(starGeo, starMat);
        supernova.position.y = treeHeight / 2;
        scene.add(supernova);

        // å…‰æ™• Sprite
        const glowMat = new THREE.SpriteMaterial({ 
            map: sprite, 
            color: 0xffd700, 
            blending: THREE.AdditiveBlending,
            transparent: true,
            opacity: 0.5
        });
        const glowSprite = new THREE.Sprite(glowMat);
        glowSprite.scale.set(10, 10, 10);
        supernova.add(glowSprite);


        // --- 7. åŠ¨ç”»å¾ªç¯ ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            
            controls.update();

            // 1. æ˜Ÿæ²³æ—‹è½¬
            // åœæ­¢è‡ªåŠ¨æ—‹è½¬æ—¶ï¼ˆç”¨æˆ·æ‹–æ‹½æ—¶ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®©æ˜Ÿæ˜Ÿè‡ªå·±å¾®åŠ¨
            starSystem.rotation.y = time * 0.05;

            // 2. é¡¶éƒ¨è¶…æ–°æ˜Ÿå‘¼å¸
            const scale = 1 + Math.sin(time * 2) * 0.1;
            supernova.scale.set(scale, scale, scale);
            glowSprite.material.rotation -= 0.01;

            // 3. ç…§ç‰‡æ¼‚æµ®æ•ˆæœ & è·ç¦»äº¤äº’
            const camPos = camera.position;
            const center = new THREE.Vector3(0,0,0);
            const dist = camPos.distanceTo(center);

            // å½“ç›¸æœºéå¸¸è¿‘æ—¶ï¼ˆç©¿è¶Šæ˜Ÿæ²³ï¼‰ï¼Œè®©ç…§ç‰‡å˜å¤§å¹¶æ˜¾ç°
            // è¿œæ™¯æ—¶ç…§ç‰‡ç¨å¾®é€æ˜ä¸€ç‚¹ï¼Œèå…¥èƒŒæ™¯
            photoSprites.forEach(sprite => {
                // ä¸Šä¸‹æ¼‚æµ®
                sprite.position.y = sprite.userData.originalY + Math.sin(time + sprite.userData.id) * 0.5;
                
                // æ°¸è¿œé¢å‘ç›¸æœº
                // Sprite é»˜è®¤å°±æ˜¯é¢å‘ç›¸æœºçš„ï¼Œä¸éœ€è¦ lookAt

                // è·ç¦»é€»è¾‘ï¼š
                // ç¦»ç…§ç‰‡è¶Šè¿‘ï¼Œå®ƒè¶Šå¤§
                const distToSprite = camPos.distanceTo(sprite.position);
                
                // ç®€å•çš„è§†è§‰ä¼˜åŒ–
                if (distToSprite < 10) {
                    sprite.material.opacity = 1; // é è¿‘é«˜äº®
                } else {
                    sprite.material.opacity = 0.7; // è¿œå¤„åŠé€æ˜
                }
            });

            // 4. ç²’å­æè´¨æ—¶é—´æ›´æ–° (å¦‚æœæœ‰shaderçš„è¯ï¼Œè¿™é‡Œç”¨ç®€å•å¤§å°æ¨¡æ‹Ÿé—ªçƒ)
            // ç•¥ï¼Œä¸ºä¿æ€§èƒ½

            renderer.render(scene, camera);
        }

        // çª—å£é€‚é…
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
